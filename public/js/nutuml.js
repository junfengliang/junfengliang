!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.nutuml=t():e.nutuml=t()}(self,(function(){return(()=>{"use strict";var e,t={d:(e,i)=>{for(var a in i)t.o(i,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:i[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},i={};t.d(i,{default:()=>Q});class a{}class l{constructor(e,t,i){this.line=e,this.value=t,this.type=i}}!function(e){e[e.LEVEL=1]="LEVEL",e[e.VALUE=2]="VALUE"}(e||(e={}));class n{constructor(e,t){this.level=e,this.title=t}addChild(e){void 0===this.children&&(this.children=[]),this.children.push(e)}}function r(e){return"syntax error. line "+e.line+" near "+e.value}const o=/<br\s*\/?>/gi,h="nut-tmp-text-666",s=function(e,t){const i=t.text.replace(o," ");let a="<text id='"+h+"'";a+='x="'+t.x+'" ',a+='y="'+t.y+'" ',a+='style="font-size:'+t.config.fontSize+"px;font-weight:"+t.config.fontWeight+";font-family:"+t.config.fontFamily+'"',a+='fill="'+t.config.textColor+'">',a+=i,a+="</text>\n",e.innerHTML=a};class f{}const d=function(){let e=new f;return e.x=0,e.y=0,e.fill="#666",e.width=100,e.height=100,e.textMargin=0,e.rx=0,e.ry=0,e},u={calculateTextDimensions:((e,t)=>{let i=new Map;return(...e)=>{let a=t?t.apply(void 0,e):e[0];if(a in i)return i.get(a);{let t=function(e,t){t=Object.assign({fontSize:14,fontWeight:400,fontFamily:"Arial"},t);const{fontSize:i,fontFamily:a,fontWeight:l}=t;if(!e)return{width:0,height:0};const n=["sans-serif",a],r=e.split(o);let f=[];const u=document.getElementsByTagName("body")[0];let c=document.createElement("svg");u.appendChild(c);for(let e of n){let e=0,i={width:0,height:0,lineHeight:0};for(let a of r){const l=d();l.text=a,l.config=t,s(c,l);let n=document.getElementById(h).getBoundingClientRect();i.width=Math.round(Math.max(i.width,n.width)),e=Math.round(n.height),i.height+=e,i.lineHeight=Math.round(Math.max(i.lineHeight,e))}f.push(i)}return c.remove(),f[isNaN(f[1].height)||isNaN(f[1].width)||isNaN(f[1].lineHeight)?0:1]}(...e);return i.set(a,t),t}}})(0,((e,t)=>`${e}-${t.fontSize}-${t.fontWeight}-${t.fontFamily}`))},c={fontSize:28,fontWeight:400,fontFamily:"Arial",horizonSpace:50,verticalSpace:40,backgroundColor:"#0081E8",textColor:"#FFF"},g={fontSize:20,fontWeight:400,fontFamily:"Arial",horizonSpace:30,verticalSpace:20,backgroundColor:"#EEE",textColor:"#141414"},v={fontSize:16,fontWeight:400,fontFamily:"Arial",horizonSpace:20,verticalSpace:20,backgroundColor:"#EEE",textColor:"#141414"};function p(e){let t=e.node;void 0===e.nodePadding&&(e.nodePadding=25),void 0===e.rootPadding&&(e.rootPadding=50),m(t),function(e,t){x(e,t),y(e,t)}(t,e)}function m(e){let t=v;1==e.level?t=c:2==e.level&&(t=g),e.textConfig=t;let i=u.calculateTextDimensions(e.title,t);if(e.textWidth=i.width,e.textHeight=i.height,e.width=i.width+t.horizonSpace,e.height=i.height+t.verticalSpace,e.childrenWidth=0,e.childrenHeight=0,null!=e.children){let t=0;for(;t<e.children.length;){let i=e.children[t++];m(i),e.childrenWidth<i.width&&(e.childrenWidth=i.width),isNaN(i.childrenHeight)?e.childrenHeight+=i.height:e.childrenHeight+=Math.max(i.height,i.childrenHeight)}}}function x(e,t){if(void 0===e.parent){e.centerX=e.width/2+5,e.centerY=Math.max(e.childrenHeight,e.height)/2;let i=e.centerX+e.width/2+5;t.svgWidth=Math.max(t.svgWidth,i);let a=e.centerY+e.height/2+5;t.svgHeight=Math.max(t.svgHeight,a)}if(void 0!==e.children){let i=0,a=e.centerY-e.childrenHeight/2;for(;i<e.children.length;){let l=e.children[i++];l.centerX=e.centerX+e.width/2+l.width/2,1==e.level?l.centerX+=t.rootPadding:l.centerX+=t.nodePadding;let n=l.centerX+l.width/2+5;t.svgWidth=Math.max(t.svgWidth,n);let r=l.height;isNaN(l.childrenHeight)||(r=Math.max(l.height,l.childrenHeight)),l.centerY=a+r/2;let o=l.centerY+l.height/2+5;t.svgHeight=Math.max(t.svgHeight,o),a+=r,x(l,t)}}}function y(e,t){if(void 0!==e.children){let i=0;for(;i<e.children.length;)y(e.children[i++],t);e.centerY=(e.children[0].centerY+e.children[e.children.length-1].centerY)/2}}const w=[":"],_=["\r","\n"],T=["hide","autonumber","as","participant","actor","boundary","control","entity","database","collections","title","header","footer","alt","else","opt","loop","par","break","critical","group","end","note","left","right","of","over","ref","activate","deactivate","destroy","box","skinparam"],b=["title","header","footer","alt","else","opt","loop","par","break","critical","group"],X=["title","note","ref"],P=["-",">","<","->","--\x3e","<-","<--"];function O(e){return/[a-z0-9]/i.test(e)||"#"==e||"["==e||"]"==e||e.charCodeAt(0)>255}class k{}const M=14,S="14px Arial",L=10,Y="#9A6A7A",H="#FEFECE",E="#ffffff",I="#333",C="#A80036",W="#BA0028",B="bold 12px Courier",A="28px Arial",N=["actor","boundary","control","entity","database"],R=["participant","actor","boundary","control","entity","database","collections"],$=["activate","deactivate","destroy"],z=["opt","loop","par","break","critical","group"],F=["->","--\x3e"],D=["<--","--\x3e"],j=new class{constructor(){this.iPar=new Map,this.iPar.set("actor",{width:34,height:54}),this.iPar.set("boundary",{width:42,height:26}),this.iPar.set("control",{width:26,height:32}),this.iPar.set("entity",{width:24,height:26}),this.iPar.set("database",{width:38,height:50});var e=document.createElement("canvas");this.context=e.getContext("2d"),this.el=document.createElement("div");var t=document.createElement("img"),i=document.createElement("div");i.style.setProperty("background-color","#fcf8e3"),this.el.appendChild(i),this.el.appendChild(t),this.img=t,this.message=i,this.canvas=e,this.tokens=[],this.debug=!1,this.keep=!1}_measureText(e,t,i){i=i||M;var a={width:0,height:0},l=t.split("\n");return l.forEach((function(t){a.width=Math.max(a.width,e.measureText(t).width)})),a.height=l.length*(i+5)+5,a}_groupRectangle(e,t){var i=t.cornerY+8,a=t.height-8;8==t.type&&(e.save(),e.beginPath(),e.fillStyle="#fff",e.fillRect(t.x,i,t.width,a),e.fill(),e.restore()),e.save(),e.beginPath(),e.lineWidth=2,e.moveTo(t.toX,i),e.lineTo(t.x,i),e.lineTo(t.x,t.toY),e.stroke(),e.restore(),e.save(),e.beginPath(),e.lineWidth=2,e.shadowBlur=3,e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowColor=Y,e.moveTo(t.toX,i),e.lineTo(t.toX,t.toY),e.lineTo(t.x,t.toY),e.stroke(),e.restore(),e.beginPath();var l=t.typeName;"group"==l&&""!=t.message&&(l=t.message,t.message=""),e.font=B;var n=this._measureText(e,l,12),r=Math.max(n.width,40);r=r+13+15;var o=n.height,h=t.x+1,s=i+1;if(e.save(),e.beginPath(),e.fillStyle="#fff",e.moveTo(h,s),e.lineTo(h+r,s),e.lineTo(h+r,s+o/2),e.lineTo(h+r-o/2,s+o),e.lineTo(h,s+o),e.closePath(),e.fill(),e.restore(),e.save(),e.beginPath(),e.moveTo(t.x,i),e.lineTo(t.x+r,i),e.lineTo(t.x+r,i+o/2),e.lineTo(t.x+r-o/2,i+o),e.lineTo(t.x,i+o),e.stroke(),e.beginPath(),e.restore(),(3==t.type||5==t.type)&&""!=t.message){var f="["+t.message+"]";this._drawGroupText(e,t.x+r+10,i-2,f,!0)}if(8==t.type){e.font=S;var d=this._measureText(e,t.message,M),u=t.x+(t.width-d.width)/2;console.log("item.x=",t.x,",txtX=",u,"item.width=",t.width,"txtwidth=",d.width);var c=s+o+5;this._drawText(e,u,c,t.message,!1)}this._drawGroupText(e,t.x+10,i-2,l,!0)}_drawCollections(e,t){var i=t.height-4,a=t.width-4;e.save(),e.beginPath(),e.shadowBlur=3,e.shadowOffsetX=4,e.shadowOffsetY=4,e.shadowColor=Y,e.fillStyle=H,e.fillRect(t.x+4,t.y,a,i),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=1,e.fillRect(t.x+4,t.y,a,i),e.strokeStyle=C,e.strokeRect(t.x+4,t.y,a,i),e.stroke(),e.fill(),e.beginPath(),e.shadowBlur=3,e.shadowOffsetX=4,e.shadowOffsetY=4,e.fillRect(t.x,t.y+4,a,i),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=1,e.fillRect(t.x,t.y+4,a,i),e.strokeStyle=C,e.strokeRect(t.x,t.y+4,a,i),e.stroke(),e.fill(),e.restore(),this._drawText(e,t.x+10,t.y+4,t.title,!0)}_activeRectangle(e,t){e.save(),e.beginPath(),e.shadowBlur=3,e.shadowOffsetX=4,e.shadowOffsetY=4,e.shadowColor=Y;var i=t.x-5,a=t.topY,l=t.bottomY-t.topY;e.fillStyle="#ffffff",e.fillRect(i,a,10,l),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=1,e.fillRect(i,a,10,l),e.strokeStyle=C,e.strokeRect(i,a,10,l),e.stroke(),e.fill(),e.restore()}_rectangle(e,t){e.save(),e.beginPath(),e.shadowBlur=3,e.shadowOffsetX=4,e.shadowOffsetY=4,e.shadowColor=Y,e.fillStyle=H,e.fillRect(t.x,t.y,t.width,t.height),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=1,e.fillRect(t.x,t.y,t.width,t.height),e.strokeStyle=C,e.strokeRect(t.x,t.y,t.width,t.height),e.stroke(),e.fill(),e.restore(),this._drawText(e,t.x+10,t.y,t.title,!0)}_noteRectangle(e,t){var i=t.cornerY+15,a=t.noteHeight-15-5,l=t.noteItem.color||"#F6FF70";e.save(),e.beginPath(),e.lineWidth=1,e.fillStyle=l,e.strokeStyle=W,e.moveTo(t.noteX,i+a),e.lineTo(t.noteX,i),e.lineTo(t.noteX+t.noteWidth-10,i),e.lineTo(t.noteX+t.noteWidth,i+10),e.lineTo(t.noteX+t.noteWidth,i+a),e.closePath(),e.stroke(),e.fill(),e.restore(),e.save(),e.beginPath(),e.lineWidth=1,e.strokeStyle=W,e.moveTo(t.noteX+t.noteWidth-10,i),e.lineTo(t.noteX+t.noteWidth-10,i+10),e.lineTo(t.noteX+t.noteWidth,i+10),e.closePath(),e.stroke(),e.restore(),e.save(),e.beginPath(),e.lineWidth=1,e.shadowBlur=3,e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowColor=Y,e.strokeStyle=W,e.moveTo(t.noteX+t.noteWidth,i+10),e.lineTo(t.noteX+t.noteWidth,i+a),e.lineTo(t.noteX,i+a),e.stroke(),e.restore(),e.beginPath(),this._drawText(e,t.noteX+10,i,t.noteItem.message,!1)}_oneParticipantSize(e,t){var i=this._measureText(e,t.title,M);t.width=i.width+20,t.height=i.height,"collections"==t.type&&(t.width+=4,t.height+=4),-1!==N.indexOf(t.type)&&(t.width=i.width,t.height+=this.iPar.get(t.type).height,t.width<this.iPar.get(t.type).width&&(t.width=this.iPar.get(t.type).width))}_calcObjSize(e,t){if(t.title.length>0){var i=this._measureText(e,t.title,28);t.titleHeight=i.height}if(t.header.length>0){var a=this._measureText(e,t.header,M);t.headerHeight=a.height}if(t.footer.length>0){var l=this._measureText(e,t.footer,M);t.footerHeight=l.height}if(t.box.length>0)for(var n=0;n<t.box.length;n++){var r=t.box[n];if(null!=r.title&&r.title.length>0){var o=this._measureText(e,r.title,M);t.boxHeight=Math.max(t.boxHeight,o.height)}}}_calcParticipantSize(e,t){e.font=S;for(var i=t.length,a=0;a<i;a++){var l=t[a];this._oneParticipantSize(e,l)}}_calcLineSize(e,t){e.font=S;for(var i=t.lines,a=i.length,l=0;l<a;l++){var n=i[l],r=this._measureText(e,n.message,M);if(n.width=r.width+20,t.autonumber){var o=this._measureText(e,"99 ",M);n.width+=o.width}if(3==n.type||5==n.type)n.height=r.height+5;else if(8==n.type)n.height=r.height+5+36,n.width=Math.max(n.width,100);else if(6==n.type)n.height=10;else if(10==n.type){var h=parseInt(n.message);n.height=h>0?h:r.height}else 9==n.type?""==n.message.trim()?n.height=25:n.height=40:n.height=r.height+5;if(n.from==n.to&&1==n.type&&(n.height+=13),n.lineHeight=n.height,null!=n.noteItem){var s=this._measureText(e,n.noteItem.message,M);n.noteWidth=s.width+10+15,n.noteHeight=s.height+15+5,n.height=Math.max(n.lineHeight,n.noteHeight)}}}_calcCrossSpan(e,t,i){if(t<2)return 0;for(var a=e.participant[t-1],l=0,n=e.participant[t],r=0;r<t-1;r++){var o=e.participant[r],h=o.name+"_"+n.name,s=n.name+"_"+o.name,f=0;void 0!==i[h]&&(f=Math.max(f,i[h])),void 0!==i[s]&&(f=Math.max(f,i[s])),f-=a.x-o.x,l=Math.max(l,f)}return l}_calcParticipantXY(e){e.innerHeight=0;var t=e.participant.length,i=[];e.maxParticipantHeight=0;for(var a=0;a<e.lines.length;a++){var l=(o=e.lines[a]).from+"_"+o.to;(void 0===i[l]||i[l]<o.width)&&(i[l]=o.width),i[l]<100&&(i[l]=100),e.innerHeight+=o.height}for(var n=0;n<t;n++)e.maxParticipantHeight=Math.max(e.participant[n].height,e.maxParticipantHeight);var r=L+e.titleHeight+e.headerHeight+e.boxHeight;for(n=0;n<t;n++){var o=e.participant[n];if(0!=n){var h=e.participant[n-1],s=h.name+"_"+o.name,f=o.name+"_"+h.name,d=h.width+10,u=Math.max(100,d);void 0!==i[s]&&(u=Math.max(u,i[s])),void 0!==i[f]&&(u=Math.max(u,i[f]));var c=this._calcCrossSpan(e,n,i);u=Math.max(u,c),o.x=h.x+u,o.y=r+e.maxParticipantHeight-o.height,o.lineX=o.x+o.width/2,o.lineY=o.y+o.height}else o.x=L,o.y=r+e.maxParticipantHeight-o.height,o.lineX=o.x+o.width/2,o.lineY=o.y+o.height}e.height=Math.ceil(e.titleHeight+e.footerHeight+e.headerHeight+e.boxHeight+19+e.innerHeight+2*e.maxParticipantHeight+20),e.box.length>0&&(e.height+=L);var g=e.participant[t-1].width,v=i[e.participant[t-1].name+"_"+e.participant[t-1].name];v&&v>g/2&&(g=g/2+v),e.width=Math.ceil(e.participant[t-1].x+g+L)}_calcLinesXY(e){for(var t,i,a=[],l=L+e.headerHeight+e.boxHeight+e.titleHeight+e.maxParticipantHeight,n=0,r=0,o=0;o<e.lines.length;o++){var h=e.lines[o];if(h.cornerY=l,h.lineY=h.cornerY+(h.height-h.lineHeight)/2,l+=h.height,h.y=l,h.toY=l,3==h.type||5==h.type?(0==a.length&&(i=void 0),a.push(h),t=h):6==h.type?(null!=(t=a.pop())&&(t.toY=l,void 0!==i&&(null==t.x?t.x=i.x-10:t.x=Math.min(t.x,i.x-10),null==t.toX?t.toX=i.toX+20:t.toX=Math.max(t.toX,i.toX+20),n=Math.min(n,t.x),r=Math.max(r,t.toX))),i=t,a.length>0&&(t=a[a.length-1])):4==h.type?h.refItem=t:7==h.type?(h.noteX=this._calcOnlyNote(h,e),n=Math.min(n,h.noteX),r=Math.max(r,h.noteX+h.noteWidth+L)):8==h.type&&(h.x=this._calcRefX(h,e),h.toX=h.x+h.width,h.toY=h.cornerY+h.height,n=Math.min(n,h.x),r=Math.max(r,h.toX+L)),1===h.type){for(var s,f,d=0;d<e.participant.length;d++)e.participant[d].name==h.from&&(s=e.participant[d]),e.participant[d].name==h.to&&(f=e.participant[d]);if(h.x=s.lineX,h.toX=f.lineX,null!=h.noteItem&&("left"==h.noteItem.direction?(h.noteX=Math.min(h.x,h.toX)-h.noteWidth-10,n=Math.min(n,h.noteX)):"right"==h.noteItem.direction&&(h.noteX=Math.max(h.x,h.toX)+10,r=Math.max(r,h.noteX+h.noteWidth+L))),null!=t){var u=Math.min(h.x,h.toX),c=Math.max(h.x,h.toX);null==t.x?t.x=u-30:t.x=Math.min(u-30,t.x),null==t.toX?t.toX=c+20:t.toX=Math.max(c+20,t.toX)}}}r+L>e.width&&(e.width=r+L),n<0&&(e.tranlateX=Math.ceil(Math.abs(n)),e.width+=e.tranlateX)}_calcRefX(e,t){for(var i,a,l=0;l<t.participant.length;l++)t.participant[l].name==e.from&&(i=t.participant[l]),t.participant[l].name==e.to&&(a=t.participant[l]);if(null==i)return 0;if(void 0!==a){var n=Math.abs(a.lineX-i.lineX)+20;return e.width=Math.max(e.width,n),(a.lineX+i.lineX)/2-e.width/2}return i.lineX-20}_calcOnlyNote(e,t){for(var i,a,l=0;l<t.participant.length;l++)t.participant[l].name==e.noteItem.participant&&(i=t.participant[l]),t.participant[l].name==e.noteItem.participantTo&&(a=t.participant[l]);return void 0!==a?(a.lineX+i.lineX)/2-e.noteWidth/2:"left"==e.noteItem.direction?i.lineX-e.noteWidth-10:"right"==e.noteItem.direction?i.lineX+10:i.lineX-e.noteWidth/2}_copyObj(e){var t={};return Object.assign(t,e),t}_delayLine(e,t,i,a,l,n){var r=10;this._realLine(e,t,i,a,n[0].from+r);for(var o=0;o<n.length;o++)o>=1&&this._realLine(e,t,n[o-1].to+r,a,n[o].from+r),this._dotedLine(e,t,n[o].from+r,a,n[o].to+r);this._realLine(e,t,n[n.length-1].to+r,a,l)}_dotedLine(e,t,i,a,l){e.save(),e.beginPath(),e.setLineDash([1,4]),e.moveTo(t,i),e.lineTo(a,l),e.stroke(),e.fill(),e.restore()}_dashedLine(e,t,i,a,l){e.save(),e.beginPath(),e.setLineDash([5,5]),e.moveTo(t,i),e.lineTo(a,l),e.stroke(),e.fill(),e.restore()}_realLine(e,t,i,a,l){e.save(),e.beginPath(),e.moveTo(t,i),e.lineTo(a,l),e.stroke(),e.fill(),e.restore()}_drawOneParticipant(e,t){"actor"==t.type?this._drawActor(e,t):"boundary"==t.type?this._drawBoundary(e,t):"control"==t.type?this._drawControl(e,t):"entity"==t.type?this._drawEntity(e,t):"database"==t.type?this._drawDatabase(e,t):"collections"==t.type?this._drawCollections(e,t):this._rectangle(e,t)}_drawOneBox(e,t){e.save(),e.beginPath(),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=1,e.fillStyle="#EEEEEE",null!=t.color&&(e.fillStyle=t.color),e.fillRect(t.x,t.y,t.width,t.height),e.strokeStyle=C,e.strokeRect(t.x,t.y,t.width,t.height),e.stroke(),e.fill(),e.restore(),e.save(),e.font=S,e.fillStyle=I;var i=this._measureText(e,t.title,M),a=t.x+(t.width-i.width)/2;this._onlyDrawText(e,a,t.y,t.title,M,!0),e.fill(),e.restore()}_drawObj(e,t){if(t.titleHeight>0){e.font=A;var i=this._measureText(e,t.title,28),a=(t.width-i.width)/2;this._drawTitleText(e,a,L+t.headerHeight,t.title)}if(t.headerHeight>0){e.font=S;var l=this._measureText(e,t.header,M),n=t.width-L-l.width;this._drawText(e,n,L,t.header,!1)}if(t.footerHeight>0){e.font=S;var r=this._measureText(e,t.footer,M),o=t.width-L-r.width;this._drawText(e,o,t.height-t.footerHeight,t.footer,!1)}if(t.box.length>0)for(var h=0;h<t.box.length;h++)this._drawOneBox(e,t.box[h])}_drawParticipant(e,t){for(var i=t.participant.length,a=this._patchDelay(t),l=0;l<i;l++){var n=t.participant[l];if("["==n.name||"]"==n.name)continue;this._drawOneParticipant(e,n);let i=new k;Object.assign(i,n),i.y=n.y+t.innerHeight+19+n.height,i.isBottom=!0,t.hideFootbox||this._drawOneParticipant(e,i),a.length>0?this._delayLine(e,n.lineX,n.lineY,n.lineX,i.y,a):this._dashedLine(e,n.lineX,n.lineY,n.lineX,i.y)}}_patchDelay(e){for(var t=e.lines.length,i=[],a=0;a<t;a++){var l=e.lines[a];9==l.type&&i.push({from:l.cornerY,to:l.cornerY+l.height})}return i}_drawRef(e,t){this._groupRectangle(e,t)}_drawActive(e,t){for(var i=0;i<t.activeLines.length;i++)this._activeRectangle(e,t.activeLines[i])}_drawLines(e,t){for(var i=t.lines.length,a=0;a<i;a++){var l=t.lines[a];1==l.type?this._line(e,l,t):2==l.type?this._separateLine(e,l,t):4==l.type?this._elseLine(e,l,t):7==l.type?this._noteRectangle(e,l):8==l.type?this._drawRef(e,l):9==l.type&&this._drawDelay(e,l,t.width)}}_drawDelay(e,t,i){if(""!=t.message.trim()){var a=(i-this._measureText(e,t.message,M).width)/2-10;this._drawText(e,a,t.lineY+20,t.message,!1)}}_drawGroupAlt(e,t){for(var i=t.lines.length,a=0;a<i;a++){var l=t.lines[a];3!=l.type&&5!=l.type||this._groupRectangle(e,l)}}_separateLine(e,t,i){e.save(),e.beginPath();var a=t.y-t.height/2+5,l=i.width/2-t.width/2,n=this._measureText(e,t.message,M),r=a-n.height/2,o=n.height,h=a-2,s=a+2;e.fillStyle=E,e.fillRect(0,h,i.width,4),e.fill(),e.moveTo(0,h),e.lineTo(i.width,h),e.moveTo(i.width,s),e.lineTo(0,s),e.stroke(),e.beginPath(),e.shadowBlur=3,e.shadowOffsetX=4,e.shadowOffsetY=4,e.shadowColor=Y,e.fillStyle=E,e.fillRect(l,r,t.width,o),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=1,e.fillRect(l,r,t.width,o),e.strokeStyle=C,e.strokeRect(l,r,t.width,o),e.stroke(),e.restore(),this._drawText(e,l+10,r-2,t.message,!1)}_drawToSelf(e,t,i){e.save(),e.beginPath(),e.moveTo(t,i),e.lineTo(t+40,i),e.lineTo(t+40,i+13),e.lineTo(t,i+13),e.stroke(),e.restore(),this._drawArrow(e,t,i+13,!0)}_elseLine(e,t,i){var a="["+t.message+"]",l=this._measureText(e,t.message,M);this._drawGroupText(e,Math.min(t.refItem.x,t.refItem.toX)+10,t.y-l.height,a,!1);var n=t.cornerY+7;this._dashedLine(e,t.refItem.x,n,t.refItem.toX,n)}_line(e,t,i){null!=t.noteItem&&this._noteRectangle(e,t);var a=t.message;if(i.autonumber&&(a=t.number+" "+a),this._measureText(e,t.message,M),t.from==t.to)return this._drawText(e,Math.min(t.x,t.toX)+10,t.lineY+5,a,!1),void this._drawToSelf(e,t.x,t.lineY+t.lineHeight-13);this._drawText(e,Math.min(t.x,t.toX)+10,t.lineY+5,a),-1!==D.indexOf(t.operator)?this._dashedLine(e,t.x,t.lineY+t.lineHeight,t.toX,t.lineY+t.lineHeight):this._realLine(e,t.x,t.lineY+t.lineHeight,t.toX,t.lineY+t.lineHeight),this._drawArrow(e,t.toX,t.lineY+t.lineHeight,t.x>t.toX)}_drawArrow(e,t,i,a){var l=-12,n=-7,r=-5;a&&(l=0-l,n=0-n,r=0-r),e.save(),e.beginPath(),e.moveTo(t,i),e.lineTo(t+l,i+r),e.lineTo(t+n,i),e.lineTo(t+l,i-r),e.lineTo(t,i),e.stroke(),e.fill(),e.restore()}_drawDatabase(e,t){var i=t.x,a=t.y;t.isBottom&&(a+=19);var l=this.iPar.get("database").width,n=this.iPar.get("database").height;t.width>l&&(i=t.x+(t.width-l)/2),e.save(),e.lineWidth=2,e.strokeStyle=C,e.fillStyle=H,e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowColor=Y,e.beginPath(),e.fillRect(t.x,a+11,38,28),e.fill(),e.lineWidth=2,e.ellipse(i+19,a+11,19,11,0,0,2*Math.PI),e.ellipse(i+19,a+39,19,11,0,0,Math.PI),e.moveTo(i,a+11),e.lineTo(i,a+39),e.moveTo(i+38,a+11),e.lineTo(i+38,a+39),e.fill(),e.stroke(),e.beginPath(),e.strokeStyle=C,e.fillStyle=H,e.shadowBlur=3,e.shadowOffsetX=2,e.shadowOffsetY=3,e.shadowColor=Y,e.moveTo(i+38,a+11),e.lineTo(i+38,a+39),e.ellipse(i+19,a+39,19,11,0,0,Math.PI),e.stroke(),e.restore(),e.save(),e.beginPath(),e.font=S,e.fillStyle=I,i=t.x;var r=e.measureText(t.title).width;r<l&&(i+=(l-r)/2),e.fontSize=M,t.isBottom?e.fillText(t.title,i,a-5):e.fillText(t.title,i,M+n+t.y),e.fill(),e.stroke(),e.restore()}_drawEntity(e,t){var i=t.x,a=t.y;t.isBottom&&(a+=19);var l=this.iPar.get("entity").width,n=this.iPar.get("entity").height;t.width>l&&(i=t.x+(t.width-l)/2),e.save(),e.lineWidth=2,e.strokeStyle=C,e.fillStyle=H,e.shadowBlur=3,e.shadowOffsetX=4,e.shadowOffsetY=4,e.shadowColor=Y,e.beginPath(),e.lineWidth=2,e.arc(i+12,a+12,12,0,2*Math.PI),e.stroke(),e.beginPath(),e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.arc(i+12,a+12,11,0,2*Math.PI),e.fill(),e.beginPath(),e.fillStyle=C,e.moveTo(i,a+25),e.lineTo(i+25,a+25),e.stroke(),e.restore(),e.save(),e.beginPath(),e.font=S,e.fillStyle=I,i=t.x;var r=e.measureText(t.title).width;r<l&&(i+=(l-r)/2),e.fontSize=M,t.isBottom?e.fillText(t.title,i,a-5):e.fillText(t.title,i,M+n+t.y),e.fill(),e.stroke(),e.restore()}_drawControl(e,t){var i=t.x,a=t.y;t.isBottom&&(a+=19);var l=this.iPar.get("control").width,n=this.iPar.get("control").height;t.width>l&&(i=t.x+(t.width-l)/2),e.save(),e.lineWidth=2,e.strokeStyle=C,e.fillStyle=H,e.shadowBlur=3,e.shadowOffsetX=4,e.shadowOffsetY=4,e.shadowColor=Y,e.beginPath(),e.lineWidth=2,e.arc(i+13,a+19,13,0,2*Math.PI),e.stroke(),e.beginPath(),e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.arc(i+13,a+19,12,0,2*Math.PI),e.fill(),e.beginPath(),e.fillStyle=C,e.moveTo(i+10,a+6),e.lineTo(i+17,a+12),e.lineTo(i+15,a+6),e.lineTo(i+17,a),e.closePath(),e.fill(),e.restore(),e.save(),e.beginPath(),e.font=S,e.fillStyle=I,i=t.x;var r=e.measureText(t.title).width;r<l&&(i+=(l-r)/2),e.fontSize=M,t.isBottom?e.fillText(t.title,i,a-5):e.fillText(t.title,i,M+n+t.y),e.fill(),e.stroke(),e.restore()}_drawBoundary(e,t){var i=t.x+1,a=t.y;t.isBottom&&(a+=19);var l=this.iPar.get("boundary").width,n=this.iPar.get("boundary").height;t.width>l&&(i=t.x+(t.width-l)/2),e.save(),e.beginPath(),e.lineWidth=2,e.strokeStyle=C,e.fillStyle=H,e.shadowBlur=3,e.shadowOffsetX=4,e.shadowOffsetY=4,e.shadowColor=Y,e.moveTo(i,a),e.lineTo(i,a+24),e.moveTo(i,a+12),e.lineTo(i+17,a+12),e.stroke(),e.beginPath(),e.lineWidth=2,e.arc(i+29,a+12,12,0,2*Math.PI),e.stroke(),e.beginPath(),e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.arc(i+29,a+12,11,0,2*Math.PI),e.fill(),e.restore(),e.save(),e.beginPath(),e.font=S,e.fillStyle=I,i=t.x;var r=e.measureText(t.title).width;r<l&&(i+=(l-r)/2),e.fontSize=M,t.isBottom?e.fillText(t.title,i,a-5):e.fillText(t.title,i,M+n+t.y),e.fill(),e.stroke(),e.restore()}_drawActor(e,t){var i=t.x+2,a=t.y;t.isBottom&&(a+=19);var l=this.iPar.get("actor").width,n=this.iPar.get("actor").height;t.width>l&&(i=t.x+(t.width-l)/2),e.save(),e.beginPath(),e.lineWidth=2,e.strokeStyle=C,e.fillStyle=H,e.arc(i+15,a+8,8,0,2*Math.PI),e.fill(),e.moveTo(i+15,a+16),e.lineTo(i+15,a+40),e.moveTo(i+2,a+22),e.lineTo(i+28,a+22),e.moveTo(i,a+54),e.lineTo(i+15,a+40),e.lineTo(i+30,a+54),e.stroke(),e.restore(),e.save(),e.beginPath(),e.font=S,e.fillStyle=I,i=t.x;var r=e.measureText(t.title).width;r<l&&(i+=(l-r)/2),t.isBottom?e.fillText(t.title,i,a-5):e.fillText(t.title,i,M+n+t.y),e.fill(),e.stroke(),e.restore()}_drawGroupText(e,t,i,a,l){e.save(),e.font=B,e.fillStyle=I,this._onlyDrawText(e,t,i,a,M,l),e.fill(),e.restore()}_drawText(e,t,i,a,l){e.save(),e.font=S,e.fillStyle=I,this._onlyDrawText(e,t,i,a,M,l),e.fill(),e.restore()}_drawTitleText(e,t,i,a){e.save(),e.font=A,e.fillStyle=I,this._onlyDrawText(e,t,i,a,M,!0),e.fill(),e.restore()}_onlyDrawText(e,t,i,a,l,n){var r=l||M,o=a.split("\n"),h=null;n&&(h=this._measureText(e,a,r));for(var s=0;s<o.length;s++){var f=t,d=i+s*(r+5);n&&(f=t+(h.width-e.measureText(o[s]).width)/2),e.fillText(o[s],f,r+d+5-1)}}_getLineItem(e,t,i){return{from:"",to:"",message:t,operator:"",number:0,type:e,typeName:i,active:[]}}isIntNum(e){return!!/^\d+$/.test(e)}_parseSkinparam(e,t,i){if(i+1<e.length){var a=e[i],l=e[i+1];"maxMessageSize"==a.value&&this.isIntNum(l.value)&&(t.maxMessageSize=l.value,i+=2)}return i}_parseRef(e,t,i){var a,l=e.length;if(i+5<l){var n=e[i+1],r=e[i+3],o=e[i+5];if("over"==e[i].value&&2==n.type&&8==e[i+2].type&&2==r.type&&":"==e[i+4].value&&3==o.type)return(a=this._getLineItem(8,o.value,"REF")).from=n.value,a.to=r.value,t.lines.push(a),i+6}if(i+3<l&&(n=e[i+1],o=e[i+3],"over"==e[i].value&&2==n.type&&":"==e[i+2].value&&3==o.type))return(a=this._getLineItem(8,o.value,"REF")).from=n.value,t.lines.push(a),i+4;if(i+4<l&&(n=e[i+1],o=e[i+2],"over"==e[i].value&&2==n.type&&3==o.type&&"end"==e[i+3].value&&"ref"==e[i+4].value))return(a=this._getLineItem(8,o.value,"REF")).from=n.value,t.lines.push(a),i+5;if(i+6<l&&(n=e[i+1],r=e[i+3],o=e[i+4],"over"==e[i].value&&2==n.type&&8==e[i+2].type&&2==n.type&&3==o.type&&"end"==e[i+5].value&&"ref"==e[i+6].value))return(a=this._getLineItem(8,o.value,"REF")).from=n.value,a.to=r.value,t.lines.push(a),i+7}isActive(e){return-1!==$.indexOf(e)}isColor(e){return void 0!==e&&"#"===e[0]}handleActive(e,t,i,a){var l=t[i++],n=t[i];return void 0!==n&&this.isColor(n.value)?(e.lines.length>0&&e.lines[e.lines.length-1].active.push({type:a,participant:l.value,color:n.value}),i+1):(2==l.type&&e.lines.length>0&&e.lines[e.lines.length-1].active.push({type:a,participant:l.value}),i)}_getObj(e){let t={participant:[],box:[],lines:[],activeLines:[],innerHeight:0,width:0,height:0,title:"",header:"",footer:"",headerHeight:0,boxHeight:0,titleHeight:0,footerHeight:0,autonumber:!1,maxMessageSize:0,hideFootbox:!1};for(var i=e.length,a=0,l=[],n=1,r=!1;a<i;){var o=e[a++];if(1==o.type){if("ref"==o.value){a=this._parseRef(e,t,a);continue}if("skinparam"==o.value){a=this._parseSkinparam(e,t,a);continue}if("box"==o.value){if(a+1<i){var h=e[a],s=e[a+1];if(2==s.type&&o.line==h.line&&o.line==s.line){t.box.push({title:h.value,color:s.value,start:null,end:null}),a+=2,r=!0;continue}if(o.line==h.line){t.box.push({title:h.value,color:null,start:null,end:null}),a+=1,r=!0;continue}}t.box.push({title:"",color:null,start:null,end:null}),r=!0;continue}if("note"==o.value){if(a+2<i){var f=e[a],d=e[a+1],u=e[a+2];if(("left"==f.value||"right"==f.value)&&":"==d.value&&3==u.type){var c={direction:f.value,message:u.value};a+=3,t.lines.length>0&&(t.lines[t.lines.length-1].noteItem=c);continue}}if(a+3<i&&(f=e[a],u=e[a+1],("left"==f.value||"right"==f.value)&&3==u.type&&"end"==e[a+2].value&&"note"==e[a+3].value)){c={direction:f.value,message:u.value},a+=4,t.lines.length>0&&(t.lines[t.lines.length-1].noteItem=c);continue}if(a+6<i){f=e[a];var g=e[a+1],v=e[a+2],p=e[a+3];if(u=e[a+4],("left"==f.value||"right"==f.value)&&"of"==g.value&&2==v.type&&3==u.type&&"end"==e[a+5].value&&"note"==e[a+6].value){let e={direction:f.value,message:u.value,color:p.value,participant:v.value};a+=7,(_=this._getLineItem(7,"","ONLY_NOTE")).noteItem=e,t.lines.push(_);continue}}if(a+4<i){f=e[a],g=e[a+1],v=e[a+2];var m=e[a+3];if(u=e[a+4],("left"==f.value||"right"==f.value)&&"of"==g.value&&2==v.type&&5==m.type&&3==u.type){let e={direction:f.value,message:u.value,participant:v.value};a+=5,(_=this._getLineItem(7,"","ONLY_NOTE")).noteItem=e,t.lines.push(_);continue}}if(a+3<i){var x=e[a];if(v=e[a+1],m=e[a+2],u=e[a+3],"over"==x.value&&2==v.type&&5==m.type&&3==u.type){let e={direction:x.value,message:u.value,participant:v.value};a+=4,(_=this._getLineItem(7,"","ONLY_NOTE")).noteItem=e,t.lines.push(_);continue}}if(a+6<i){x=e[a],v=e[a+1];var y=e[a+2],w=e[a+3];if(p=e[a+4],m=e[a+5],u=e[a+6],"over"==x.value&&2==v.type&&8==y.type&&2==w.type&&5==m.type&&3==u.type){let e={direction:x.value,message:u.value,participant:v.value,color:p.value,participantTo:w.value};a+=7,(_=this._getLineItem(7,"","ONLY_NOTE")).noteItem=e,t.lines.push(_);continue}}if(a+6<i&&(x=e[a],v=e[a+1],y=e[a+2],w=e[a+3],u=e[a+4],"over"==x.value&&2==v.type&&8==y.type&&2==w.type&&3==u.type&&"end"==e[a+5].value&&"note"==e[a+6].value)){let e={direction:x.value,message:u.value,participant:v.value,participantTo:w.value};var _;a+=7,(_=this._getLineItem(7,"","ONLY_NOTE")).noteItem=e,t.lines.push(_);continue}}if("autonumber"==o.value){t.autonumber=!0;continue}if("title"==o.value&&3==(b=e[a++]).type&&(t.title=b.value),this.isActive(o.value)){a=this.handleActive(t,e,a,o.value);continue}if("header"==o.value&&3==(b=e[a++]).type&&(t.header=b.value),"footer"==o.value&&3==(b=e[a++]).type&&(t.footer=b.value),"hide"==o.value){"footbox"==e[a].value&&(t.hideFootbox=!0,a++);continue}if("alt"==o.value){var T="";a<i&&3==(h=e[a]).type&&(T=h.value,a++),t.lines.push(this._getLineItem(3,T,o.value));continue}if("else"==o.value){T="",a<i&&3==(h=e[a]).type&&(T=h.value,a++),t.lines.push(this._getLineItem(4,T,o.value));continue}if("end"==o.value){if(a>=i){t.lines.push(this._getLineItem(6,"",o.value));continue}if("box"==(h=e[a]).value){r=!1,a++;continue}t.lines.push(this._getLineItem(6,"",o.value));continue}if(-1!==z.indexOf(o.value)){T="",a<i&&3==(h=e[a]).type&&(T=h.value,a++),t.lines.push(this._getLineItem(5,T,o.value));continue}if(-1!==R.indexOf(o.value)){var b=e[a++];if(a+1<i){var X=e[a],P=e[a+1];if(2==b.type&&"as"==X.value&&6==P.type){t.participant.push({name:b.value,title:P.value,type:o.value}),l.push(b.value),this.setBox(t,r,b.value),a+=2;continue}if(6==b.type&&"as"==X.value&&2==P.type){t.participant.push({name:P.value,title:b.value,type:o.value}),l.push(P.value),this.setBox(t,r,P.value),a+=2;continue}}if(2==b.type){t.participant.push({name:b.value,title:b.value,type:o.value}),l.push(b.value),this.setBox(t,r,b.value);continue}}}if(9!=o.type)if(10!=o.type){if(2==o.type||6==o.type||7==o.type){var O=this._getLineItem(1,"","SEQUENCE");if(7==o.type){O.type=2,O.message=o.value,t.lines.push(O);continue}if(-1==l.indexOf(o.value)&&(t.participant.push({name:o.value,title:o.value,type:"participant"}),l.push(o.value)),a>=i)break;if(4!=(b=e[a++]).type)return t.error=o,t;if(a>=i)break;O.operator=b.value;var k=e[a++],M={name:k.value,title:k.value,type:"participant"};if(a<i){var S=e[a];if(1==S.type&&"as"==S.value){a++;var L=e[a++];2==L.type?M.name=L.value:6==L.type&&(M.title=L.value),a<i&&(S=e[a])}if(5==S.type){var Y=e[++a];3==Y.type&&(O.message=Y.value)}}-1==l.indexOf(M.name)&&(t.participant.push(M),l.push(M.name)),-1!==F.indexOf(b.value)?(O.from=o.value,O.to=M.name):(O.from=M.name,O.to=o.value),O.number=n++,t.lines.push(O)}}else t.lines.push(this._getLineItem(10,o.value,"SPACE"));else t.lines.push(this._getLineItem(9,o.value,"DELAY"))}return this.sortParticipant(t),t}wordwrap(e,t,i){for(var a=t.split("\n"),l=[],n=0;n<a.length;n++){var r=a[n];if(e.measureText(r).width<=i){l.push(r);continue}let s=0;for(var o="";s<r.length;){let a=""+t[s++];for(;s<t.length&&" "!=t[s]&&t.charCodeAt(s)<256;)a+=t[s++];var h=e.measureText(a).width;let n=e.measureText(o).width;if(h>i){let t=0,r=a[t++];for(;t<a.length;)e.measureText(r+a[t]).width+n>i?(l.push(o+r),o="",n=0,r=a[t]):r+=a[t],t++;o=r}else h+n>i?(l.push(o.trim()),o=" "!=a[0]||a.length>1?a:""):o+=a}o.length>0&&l.push(o.trim())}return l.join("\n")}handleMaxMessage(e,t){if(e.save(),e.font=S,e.fillStyle=I,!(t.maxMessageSize<=0)){for(var i=0;i<t.lines.length;i++){var a=t.lines[i];a.message=this.wordwrap(e,a.message,t.maxMessageSize)}e.restore()}}sortParticipant(e){for(var t=[],i=null,a=null,l=0;l<e.participant.length;l++){var n=e.participant[l];"["==n.name?i=n:"]"==n.name?a=n:t.push(n)}null!=a&&t.push(a),null!=i&&t.unshift(i),e.participant=t}setBox(e,t,i){if(t){var a=e.box[e.box.length-1];null==a.start&&(a.start=i),a.end=i}}_getParByName(e,t){for(var i=0;i<e.participant.length;i++)if(t==e.participant[i].name)return e.participant[i]}_patchLine(e,t){var i=t[e.from],a=t[e.to];""===e.from&&""===e.to||(e.from===e.to&&void 0!==i&&i.length>0&&(e.x+=10*i.length/2,e.toX+=10*a.length/2),e.x<e.toX?(void 0!==i&&i.length>0&&(e.x+=10*i.length/2),void 0!==a&&a.length>0&&(e.toX=e.toX+10*(a.length-2)/2)):e.x>e.toX&&(void 0!==i&&i.length>0&&(e.x+=10*i.length/2),void 0!==a&&a.length>0&&(e.toX+=5)))}_calcActiveOne(e,t,i,a){var l=e.active[i],n=t[l.participant],r=this._getParByName(a,l.participant);if(void 0!==r){var o=e.y;if("activate"!=l.type){this._patchLine(e,t);var h=n.pop();if(void 0===h)return;return h.bottomY=o,h.type=l.type,h}if(void 0===n||0==n.length)(n=[]).push({x:r.lineX,topY:o}),t[l.participant]=n;else{var s=n[n.length-1].x+5;n.push({x:s,topY:o})}this._patchLine(e,t)}else console.log("undefined"+l.participant)}_calcActiveLines(e){let t=new Array;for(var i=0;i<e.lines.length;i++){var a=e.lines[i];if(a.active.length>0)for(var l=0;l<a.active.length;l++){var n=this._calcActiveOne(a,t,l,e);void 0!==n&&e.activeLines.push(n)}else this._patchLine(a,t)}e.activeLines.reverse()}_calcBoxXY(e){if(0!=e.box.length)for(var t=0;t<e.box.length;t++){var i=e.box[t];i.x=0;for(var a=0;a<e.participant.length;a++)if((n=e.participant[a]).name==i.start){i.x=n.x-L;break}var l=0;for(a=0;a<e.participant.length;a++){var n;if((n=e.participant[a]).name==i.end){l=n.x-i.x+n.width+L;break}}i.y=e.titleHeight+e.headerHeight,i.width=l,i.height=e.height-e.titleHeight-e.headerHeight-e.footerHeight-L}}drawUml(e){var t=function(e){let t=0,i=[];for(var a=!1,l=!1,n=1;t<e.length;){if(-1!==_.indexOf(e[t])&&1==a&&(l=!0,n++,a=!1,t++),l){for(var r="",o=!0,h=n;t<e.length;)if(o)if(O(e[t])){let a=""+e[t++];for(;t<e.length&&O(e[t]);)a+=e[t++];if("end"==a){l=!1,i.push({type:3,value:r.trim(),line:h}),i.push({type:1,value:a,line:n});break}r+=a,o=!1}else r+=e[t++];else-1!==_.indexOf(e[t])&&(o=!0,n++),r+=e[t++];l=!1}if(/\s/.test(e[t]))"\n"==e[t]&&n++,t++;else if(O(e[t])){let l=""+e[t++];for(;t<e.length&&O(e[t]);)l+=e[t++];if(-1!==T.indexOf(l)){if(i.push({type:1,value:l,line:n}),-1!==X.indexOf(l)&&(i.length<2||"end"!=i[i.length-2].value)&&(a=!0),-1!==b.indexOf(l)){for(;t<e.length&&/\s/.test(e[t])&&-1==_.indexOf(e[t]);)t++;for(var s="";t<e.length&&-1==_.indexOf(e[t]);)s+=e[t++],a=!1;i.push({type:3,value:s,line:n})}}else i.push({type:2,value:l,line:n})}else if(-1!==w.indexOf(e[t])){a=!1,i.push({type:5,value:e[t++],line:n});let l="";for(;t<e.length&&" "==e[t];)t++;for(;t<e.length&&-1==_.indexOf(e[t]);)l+=e[t++];l=l.replace(/\\n/g,"\n"),i.push({type:3,value:l,line:n})}else if(","==e[t])i.push({type:8,value:e[t++],line:n});else if("."==e[t]){if(r="",!(t+2<e.length&&"."==e[t+1]&&"."==e[t+2]))return"syntax error";for(t+=3;t<e.length;){if("."==e[t]&&t+2<e.length&&"."==e[t+1]&&"."==e[t+2]){t+=3;break}if("\n"==e[t])break;r+=e[t++]}i.push({type:9,value:r,line:n})}else if("|"==e[t]){if(r="",t+2<e.length&&"|"==e[t+1]&&"|"==e[t+2])t+=3;else{if(!(t+1<e.length&&"|"==e[t+1]))return"syntax error";for(t+=2;t<e.length;){if("|"==e[t]&&t+1<e.length&&"|"==e[t+1]){t+=2;break}if("\n"==e[t])break;r+=e[t++]}}i.push({type:10,value:r,line:n})}else if(-1!==P.indexOf(e[t])){let a=""+e[t++];for(;t<e.length&&-1!==P.indexOf(e[t]);)a+=e[t++];i.push({type:4,value:a,line:n})}else if('"'==e[t]){let a="";for(t++;t<e.length&&'"'!=(f=e[t++]);)a+=f;a=a.replace("\\n","\n"),i.push({type:6,value:a,line:n})}else{if("="!=e[t])return"syntax error:"+e[t];if(t++,"="!=e[t])return"syntax error";for(r="",t++;t<e.length;){var f;if("="==(f=e[t++])&&t<e.length&&"="==e[t]){t++;break}r+=f}i.push({type:7,value:r,line:n})}}return i}(e);if(this.keep||(this.img.src="#",this.img.style.setProperty("display","none")),this.debug&&console.log(t),!(t instanceof Array))return t;this.tokens=t;var i=this._getObj(this.tokens);if(this.debug&&console.log(i),void 0!==i.error)return console.log("error"+JSON.stringify(i.error)),this.message.innerText='Syntax error near "'+i.error.value+'" at line '+i.error.line,this.message.style.setProperty("background-color","#fcf8e3"),this.message.style.setProperty("padding","15px"),this.message.style.setProperty("font-family",'"Helvetica Neue",Helvetica,Arial,sans-serif'),this.message.style.setProperty("font-size","14px"),this.message.style.setProperty("line-height","1.42857143"),this.message.style.setProperty("color","#333"),this.message.style.setProperty("display","block"),"";this.message.style.setProperty("display","none"),this.message.innerHTML="";var a=this.context;return a.lineWidth=1,this.handleMaxMessage(a,i),this._calcObjSize(a,i),this._calcParticipantSize(a,i.participant),this._calcLineSize(a,i),this._calcParticipantXY(i),this._calcLinesXY(i),this._calcActiveLines(i),this._calcBoxXY(i),this.canvas.width=i.width,this.canvas.height=i.height,a.translate(.5,.5),this._drawObj(a,i),null!=i.tranlateX&&a.translate(i.tranlateX,.5),this._drawParticipant(a,i),this._drawGroupAlt(a,i),this._drawActive(a,i),this._drawLines(a,i),this.img.src=this.canvas.toDataURL(),this.img.style.setProperty("display","block"),""}render(e){return this.drawUml(e),this.el.innerHTML}};j.keep=!0;const U=new class{render(t){let i=new a;if(i.svgHeight=100,i.svgWidth=100,function(t,i){const a=["\n"],n=["#"];let r=0,o=[];for(var h=1;r<t.length;)if(/\s/.test(t[r]))a.includes(t[r])&&h++,r++;else if(n.includes(t[r])){let i=""+t[r++];for(;r<t.length&&n.includes(t[r]);)i+=t[r++];o.push(new l(h,i,e.LEVEL));let s="";for(;r<t.length&&!a.includes(t[r]);)s+=t[r++];o.push(new l(h,s.trim(),e.VALUE))}else for(;r<t.length;){if(a.includes(t[r])){h++;break}r++}i.tokens=o}(t,i),function(t){let i=t.tokens;if(void 0===i||null==i)return null;let a=i.length,l=0,o=null,h=null;for(;l<a;){let s=i[l++];if(s.type!=e.LEVEL)return void(t.error=r(s));if(l>=a)return void(t.error=r(s));let f=i[l++];if(f.type!=e.VALUE)return void(t.error=r(s));let d=new n(s.value.length,f.value);if(1==d.level){if(null!=o)return void(t.error="multiple root element is not supported.");o=d}else if(d.level-1==h.level)h.addChild(d),d.parent=h;else if(d.level==h.level)h.parent.addChild(d),d.parent=h.parent;else{if(!(d.level<h.level))return void(t.error=r(f));if(2==d.level)o.addChild(d),d.parent=o;else{let e=h.parent;for(;e.level>d.level;)e=e.parent;e.parent.addChild(d),d.parent=e.parent}}h=d}t.node=o}(i),i.error)return{error:i.error,html:""};p(i);let o=function(e){let t=`<svg xmlns="http://www.w3.org/2000/svg" width="${e.svgWidth}" height="${e.svgHeight}" version="1.1">`;return function e(l){let n=l.centerX-l.width/2,r=l.centerY-(l.height-10)/2,o=l.width,h=l.height-10,s="<rect ";s+='x="'+n+'" ',s+='y="'+r+'" ',s+=' rx="5" ry="5" ',s+='width="'+o+'" ',s+='height="'+h+'" ',s+='style="fill:'+l.textConfig.backgroundColor+';fill-opacity:1" ',s+="/>";let f="<text ";f+='x="'+(l.centerX-l.textWidth/2)+'" ',f+='y="'+(r+h/2+l.textHeight/3)+'" ';let d=l.textConfig;if(f+='style="font-size:'+d.fontSize+";font-weight:"+d.fontWeight+";font-family:"+d.fontFamily+'"',f+='fill="'+l.textConfig.textColor+'">',f+=l.title,f+="</text>\n",null!=l.children){let n=0;for(;n<l.children.length;){let r=l.children[n],o="<path ",h=l.centerX,s=r.centerX-r.width/2-l.centerX;l.level>1&&(h=l.centerX+l.width/2,s-=l.width/2),1==l.level?(h=i(h,n,l.children.length,l.textWidth/2),s-=h-l.centerX,o+='d=" M '+h+" "+l.centerY+" q 0 "+(r.centerY-l.centerY)+" "+s+" "+(r.centerY-l.centerY)+'"',o+=' stroke-width="2"'):(o+='d="'+a(h,l.centerY,r.centerX-r.width/2,r.centerY)+'"',o+=' stroke-width="1"'),o+=' stroke="#333" fill="none" />\n',t+=o,e(r),n++}}t+=s+"\n",t+=f}(e.node),t+="</svg>",t;function i(e,t,i,a){let l=Math.ceil(i/2),n=Math.abs(t+1-l);return n>4&&(n=4),e+a*(4-n)/4}function a(e,t,i,a){let l=(e+i)/2;if(t==a)return`M${e} ${t} L${i} ${a}`;if(Math.abs(t-a)<=10)return`M${e} ${t} L${l} ${t} L${l} ${a} L${i} ${a}`;if(t>a){let n=-10;return`M${e} ${t} L${l} ${t} L${l} ${a+10} q 0 ${n} 10 ${n} L${i} ${a}`}return`M${e} ${t} L${l} ${t} L${l} ${a-10} q 0 10 10 10 L${i} ${a}`}}(i);return console.log(i),{error:i.error,html:o}}};let V="";var G;!function(e){e[e.SEQUENCE=0]="SEQUENCE",e[e.MINDMAP=1]="MINDMAP"}(G||(G={}));const Q={render:function(e){let t;switch(function(e){let t=0,i="";for(;t<e.length&&/\s/.test(e[t]);)t++;for(;t<e.length&&!/\s/.test(e[t]);)i+=e[t++];return i.startsWith("#")||i.startsWith("@mindmap")?G.MINDMAP:G.SEQUENCE}(e)){case G.SEQUENCE:return j.render(e);case G.MINDMAP:t=U.render(e);break;default:return j.render(e)}if(!t)return"render error.";if(null==t?void 0:t.error){let e="<div class='nutuml-error'>"+t.error+"</div>";return j.keep?e+V:e}return V=t.html,t.html},setKeep:function(e){j.keep=e}};return i.default})()}));
//# sourceMappingURL=nutuml.min.js.map